<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocketMap</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100%;
            width: 100%;
            margin: 0;
        }

        .leaflet-container {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
<h3>Map:</h3>

<label for="roleSelect">Select:</label><select id="roleSelect">
    <option value="client">Клиент</option>
    <option value="courier">Курьер</option>
</select>

<div id="map"></div>

<script>

    let isCourier = false;

    const roleSelect = document.getElementById("roleSelect");
    roleSelect.addEventListener("change", function () {
        isCourier = roleSelect.valueOf() === "courier";
        location.reload();
    });

    if (localStorage.getItem("role")) {
        roleSelect.value = localStorage.getItem("role");
        isCourier = roleSelect.value === "courier";
    }

    roleSelect.addEventListener("change", () => {
        localStorage.setItem("role", roleSelect.value);
    });

    //Инициализируем карту Leaflet
    const map = L.map('map', {
        center: [20, 0],
        zoom: 5,  // Уровень увеличения по умолчанию
        minZoom: 4,
        maxZoom: 19,
        maxBounds: [
            [-60, -180],
            [80, 180]
        ],
        maxBoundsViscosity: 1.0
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        minZoom: 2,
        noWrap: true
    }).addTo(map);

    const customIcon = L.icon({
        iconUrl: 'bus.png',
        iconSize: [36, 36],
        iconAnchor: [16, 36],
        popupAnchor: [0, -36]
    });

    const defaultIcon = L.icon({
        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    let userLocationMarker;

    let clientLatLng = null; // здесь будет настоящее положение клиента

    const socket = new WebSocket('ws://localhost:8080/ws/web');

    let myUUID = localStorage.getItem("myUUID");
    if (!myUUID) {
        myUUID = crypto.randomUUID();
        localStorage.setItem("myUUID", myUUID);
    }

    function sendLocation(lat, lng) {
        const payload = {
            uuid: myUUID,
            lat: lat,
            lng: lng
        };
        socket.send(JSON.stringify(payload));
    }

    const courierRoutes = {};

    function drawRoute(uuid, start, end) {

        const apiKey = '5b3ce3597851110001cf6248a4be1e22e72845cd9352c0187e9d67cd'; //УБРАТЬ ПРИ КОММИТЕ
        const url = 'https://api.openrouteservice.org/v2/directions/driving-car';

        fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({coordinates: [[start.lng, start.lat], [end.lng, end.lat]]})
        })
            .then(response => response.json())
            .then(data => {
                console.log("data.routes: ", data.routes);

                if (!data.routes || !data.routes[0]) {
                    console.error("Нет маршрута в ответе", data);
                    return;
                }

                const encoded = data.routes[0].geometry;
                const decodedCoords = decodePolyline(encoded);

                // Удалить старый маршрут и маркер, если есть
                if (courierRoutes[uuid]) {
                    if (courierRoutes[uuid].line) map.removeLayer(courierRoutes[uuid].line);
                    if (courierRoutes[uuid].marker) map.removeLayer(courierRoutes[uuid].marker);
                }

                // Удаляем статическую иконку, если есть
                if (courierMarkers[uuid]) {
                    map.removeLayer(courierMarkers[uuid]);
                    delete courierMarkers[uuid];
                }

                const line = L.polyline(decodedCoords, {color: 'blue', weight: 4}).addTo(map)
                const marker = L.marker(decodedCoords[0], {icon: customIcon}).addTo(map);

                let index = 0;

                function move() {
                    if (index < decodedCoords.length) {
                        marker.setLatLng(decodedCoords[index]);
                        index++;
                        setTimeout(move, 650); //скорость движения
                    }
                }

                move(); //запуск движения

                courierRoutes[uuid] = {
                    line,
                    marker,
                    index: 0
                };
            })
            .catch(error => console.error('Ошибка маршрута: ', error));
    }

    function decodePolyline(encoded) {
        let points = [];
        let index = 0, len = encoded.length;
        let lat = 0, lng = 0;

        while (index < len) {
            let b, shift = 0, result = 0;

            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);

            let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lat += dlat;

            shift = 0;
            result = 0;

            do {
                b = encoded.charCodeAt(index++) - 63;
                result |= (b & 0x1f) << shift;
                shift += 5;
            } while (b >= 0x20);

            let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
            lng += dlng;

            points.push([lat / 1E5, lng / 1E5]);
        }

        return points;
    }

    const courierMarkers = {};

    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        const {uuid, lat, lng} = data;

        if (uuid === myUUID) return; // не отображать себя

        const courierLatLng = [lat, lng];
        const courierPost = {lat, lng};
        const clientPos = {lat: clientLatLng[0], lng: clientLatLng[1]}

        // Только клиент видит маршрут
        if (!isCourier) {
            drawRoute(uuid, courierPost, clientPos);
        }

        // Удаляем статический маркер, если у нас уже есть анимированный
        if (courierRoutes[uuid]) {
            if (courierMarkers[uuid]) {
                map.removeLayer(courierMarkers[uuid]);
                delete courierMarkers[uuid];
            }
            return;
        }

        /// Только если ещё нет анимации и маркера — показываем статический маркер курьера
        if (!courierRoutes[uuid] && !courierMarkers[uuid]) {
            courierMarkers[uuid] = L.marker(courierLatLng, {icon: customIcon})
                .bindPopup(`Курьер: ${uuid}`)
                .addTo(map);
        }
    };

    socket.onopen = function () {
        console.log('WebSocket is open now.');

        // если ты курьер, отправляем текущую геолокацию на сервер через sendLocation()
        if (isCourier) {
            navigator.geolocation.watchPosition(position => {
                const {latitude, longitude} = position.coords;

                //console.log(`Отправка координат: lat=${latitude}, lng=${longitude}`)

                if (socket.readyState === WebSocket.OPEN) {
                    sendLocation(latitude, longitude);
                }
            }, error => {
                console.error("Ошибка геолокации", error)
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });
        }
    };

    socket.onerror = function (error) {
        console.error('WebSocket Error:', error);
    };

    socket.onclose = function (event) {
        if (event.wasClean) {
            console.log(`Connection closed cleanly, code=${event.code}, reason=${event.reason}`);
        } else {
            console.error('Connection died');
        }
    };

    window.onload = function () {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const {latitude, longitude} = position.coords;
                const currentLocation = [latitude, longitude];

                if (!userLocationMarker) {
                    userLocationMarker = L.marker(currentLocation, {icon: defaultIcon})
                        .addTo(map)
                        .bindPopup(isCourier ? "Вы — курьер" : "Вы находитесь здесь")
                        .openPopup();
                } else {
                    userLocationMarker.setLatLng(currentLocation);
                }

                map.setView(currentLocation, 13);

                // Сохраняем координаты клиента
                if (!isCourier) {
                    clientLatLng = currentLocation;
                }

            }, error => {
                console.error('Ошибка геолокации:', error);
                alert('Ошибка геолокации: ' + error.message);
            });
        } else {
            alert("Геолокация не поддерживается этим браузером.");
        }
    };

</script>
</body>
</html>